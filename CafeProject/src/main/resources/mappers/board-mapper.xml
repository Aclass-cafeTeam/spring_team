<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">

<!-- Board resultMap -->
<resultMap type="Board" id="board_rm">
      <id property="boardNo" column="BOARD_NO"/>
      <result property="boardTitle" column="BOARD_TITLE"/>
      <result property="boardName" column="BOARD_NAME"/>
      <result property="boardContent" column="BOARD_CONTENT"/>
      <result property="boardCreateDate" column="B_CREATE_DATE"/>
      <result property="boardUpdateDate" column="B_UPDATE_DATE"/>
      <result property="readCount" column="READ_COUNT"/>
      <result property="commentCount" column="COMMENT_COUNT"/>
      <result property="likeCount" column="LIKE_COUNT"/>
      <result property="memberNickname" column="MEMBER_NICKNAME"/>
      <result property="memberNo" column="MEMBER_NO"/>
      <result property="profileImage" column="PROFILE_IMG"/>
      <result property="titleTagName" column="TITLE_TAG_NAME"/>
      <result property="memberLevelImage" column="MEMBER_LEVEL_IMG"/>
</resultMap>




<!-- 게시판 이름 목록 조회 -->
<select id="selectBoardType" resultType="map">
SELECT * FROM BOARD_TYPE
ORDER BY 1
</select>

<!-- 게시글 수 조회 -->
<select id="getListCount" parameterType="_int" resultType="_int">
SELECT COUNT(*) FROM BOARD
WHERE BOARD_CODE = #{boardCode}
AND BOARD_DEL_FL = 'N'
AND NOTICE_FL = '0'
</select>

<!-- 전체 게시글 수 조회 -->
<select id="getAllListCount_search" resultType="_int">
SELECT COUNT(*) FROM BOARD
WHERE BOARD_DEL_FL = 'N'
</select>

<!-- <![CDATA[ sql ]]> -->

<!-- 특정 게시판 목록 조회 -->
<select id="selectBoardList" parameterType="_int" resultMap="board_rm">
SELECT BOARD_NO, TITLE_TAG_NO, TITLE_TAG_NAME, BOARD_TITLE, MEMBER_NO, MEMBER_NICKNAME, READ_COUNT, MEMBER_LEVEL_IMG, BOARD_NAME,
<![CDATA[
CASE  
      WHEN SYSDATE - B_CREATE_DATE < 1/24/60
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
      WHEN SYSDATE - B_CREATE_DATE < 1/24
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
      WHEN SYSDATE - B_CREATE_DATE < 1
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
      ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
   END B_CREATE_DATE,
   ]]>
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO =B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
	(SELECT COUNT(*) FROM BOARD_LIKE L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
FROM BOARD B
JOIN MEMBER USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
LEFT JOIN MEMBER_LEVEL USING(MEMBER_LEVEL_NO)
JOIN BOARD_TYPE USING(BOARD_CODE)
WHERE BOARD_CODE  = #{boardCode}
AND BOARD_DEL_FL = 'N'
AND NOTICE_FL = 0
ORDER BY BOARD_NO DESC
</select>

<!-- 게시판별 공지 목록 조회 -->
<select id="selectBoardNoticeList" parameterType="_int" resultMap="board_rm">
SELECT BOARD_NO, TITLE_TAG_NO, TITLE_TAG_NAME, BOARD_TITLE, MEMBER_NO, MEMBER_NICKNAME, READ_COUNT, MEMBER_LEVEL_IMG, BOARD_NAME,
<![CDATA[
CASE  
      WHEN SYSDATE - B_CREATE_DATE < 1/24/60
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
      WHEN SYSDATE - B_CREATE_DATE < 1/24
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
      WHEN SYSDATE - B_CREATE_DATE < 1
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
      ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
   END B_CREATE_DATE,
   ]]>
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO =B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
	(SELECT COUNT(*) FROM BOARD_LIKE L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
FROM BOARD B
JOIN MEMBER USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
LEFT JOIN MEMBER_LEVEL USING(MEMBER_LEVEL_NO)
JOIN BOARD_TYPE USING(BOARD_CODE)
WHERE BOARD_CODE  = #{boardCode}
AND BOARD_DEL_FL = 'N'
AND NOTICE_FL = 1
ORDER BY BOARD_NO DESC
</select>   
      
<!-- 전체 게시판 목록 조회 -->
<select id="selectBoardAllList" resultMap="board_rm">
SELECT BOARD_NO, BOARD_CODE, TITLE_TAG_NO, TITLE_TAG_NAME, BOARD_TITLE, MEMBER_NO, MEMBER_NICKNAME, READ_COUNT, MEMBER_LEVEL_IMG,
<![CDATA[
CASE  
      WHEN SYSDATE - B_CREATE_DATE < 1/24/60
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
      WHEN SYSDATE - B_CREATE_DATE < 1/24
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
      WHEN SYSDATE - B_CREATE_DATE < 1
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
      ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
   END B_CREATE_DATE,
   ]]>
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO =B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
	(SELECT COUNT(*) FROM BOARD_LIKE L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
FROM BOARD B
JOIN MEMBER USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
LEFT JOIN MEMBER_LEVEL USING(MEMBER_LEVEL_NO)
WHERE BOARD_DEL_FL = 'N'
ORDER BY BOARD_NO DESC
</select>
   
<!-- 베스트 게시글 TOP 10 조회 -->
<select id="selectBoardBestList" resultMap="board_rm">
SELECT BOARD_NO, BOARD_CODE, TITLE_TAG_NO, TITLE_TAG_NAME, BOARD_TITLE, MEMBER_NO, MEMBER_NICKNAME, READ_COUNT, MEMBER_LEVEL_IMG,
<![CDATA[
CASE
      WHEN SYSDATE - B_CREATE_DATE < 1/24/60
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
      WHEN SYSDATE - B_CREATE_DATE < 1/24
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
      WHEN SYSDATE - B_CREATE_DATE < 1
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
      ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
   END B_CREATE_DATE,
   ]]>
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO =B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
	(SELECT COUNT(*) FROM BOARD_LIKE L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
FROM BOARD B
JOIN MEMBER USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
LEFT JOIN MEMBER_LEVEL USING(MEMBER_LEVEL_NO)
WHERE BOARD_DEL_FL = 'N'
AND NOTICE_FL = '0'
ORDER BY READ_COUNT DESC
</select>
   
<!-- 검색 조건 일치 게시글 수 조회 -->   
<select id="selectBoardList_search" parameterType="_int" resultMap="board_rm">
SELECT BOARD_NO, TITLE_TAG_NO, TITLE_TAG_NAME, BOARD_TITLE, MEMBER_NO, MEMBER_NICKNAME, READ_COUNT, MEMBER_LEVEL_IMG, BOARD_NAME, 
<![CDATA[
CASE  
      WHEN SYSDATE - B_CREATE_DATE < 1/24/60
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
      WHEN SYSDATE - B_CREATE_DATE < 1/24
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
      WHEN SYSDATE - B_CREATE_DATE < 1
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
      ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
   END B_CREATE_DATE,
   ]]>
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO =B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
	(SELECT COUNT(*) FROM BOARD_LIKE L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
FROM BOARD B
JOIN MEMBER USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
LEFT JOIN MEMBER_LEVEL USING(MEMBER_LEVEL_NO)
JOIN BOARD_TYPE USING(BOARD_CODE)
WHERE BOARD_CODE = #{boardCode}
AND BOARD_DEL_FL = 'N'
AND NOTICE_FL = 0
<!-- 검색어가 있을 경우 -->
<if test='query != null and query != "" ' >
	<choose>
		<when test='key == "aa" ' >
		AND BOARD_TITLE LIKE '%${query}%'
		</when>
	
		<when test='key == "bb" ' >
		AND BOARD_CONTENT LIKE '%${query}%'
		</when>
		
		<when test='key == "cc" ' >
		AND (BOARD_TITLE LIKE '%${query}%' OR BOARD_CONTENT LIKE '%${query}%')
		</when>
		
		<when test='key == "dd" ' >
		AND MEMBER_NICKNAME LIKE '%${query}%'
		</when>
		
		<otherwise>
		AND TITLE_TAG_NAME LIKE '%${query}%'
		</otherwise>	
		
	</choose>
</if>
ORDER BY BOARD_NO DESC
</select>
   
<!-- 특정 게시판 목록 조회 -->
<!-- <select id="selectBoardList" parameterType="_int" resultMap="board_rm">
SELECT BOARD_NO, TITLE_TAG_NO, TITLE_TAG_NAME, BOARD_TITLE, MEMBER_NO, MEMBER_NICKNAME, READ_COUNT, MEMBER_LEVEL_IMG, BOARD_NAME,
<![CDATA[
CASE  
      WHEN SYSDATE - B_CREATE_DATE < 1/24/60
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
      WHEN SYSDATE - B_CREATE_DATE < 1/24
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
      WHEN SYSDATE - B_CREATE_DATE < 1
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
      ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
   END B_CREATE_DATE,
   ]]>
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO =B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
	(SELECT COUNT(*) FROM BOARD_LIKE L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
FROM BOARD B
JOIN MEMBER USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
LEFT JOIN MEMBER_LEVEL USING(MEMBER_LEVEL_NO)
JOIN BOARD_TYPE USING(BOARD_CODE)
WHERE BOARD_CODE  = #{boardCode}
AND BOARD_DEL_FL = 'N'
AND NOTICE_FL = 0
ORDER BY BOARD_NO DESC
</select>   --> 

<!-- 검색 조건 일치 게시글 수 조회 2022-11-25 -->
<!-- 마이바티스 동적 SQL <if> / <choose>, <when>, <otherwise> -->
<select id="getListCount_search" resultType="_int">
SELECT COUNT(*) FROM BOARD
JOIN "MEMBER" USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
WHERE BOARD_CODE = #{boardCode}
AND BOARD_DEL_FL = 'N'
AND NOTICE_FL = 0

<!-- 검색어가 있을 경우 -->
<if test='query != null and query != "" ' >
	<choose>
		<when test='key == "aa" ' >
		AND BOARD_TITLE LIKE '%${query}%'
		</when>
	
		<when test='key == "bb" ' >
		AND BOARD_CONTENT LIKE '%${query}%'
		</when>
		
		<when test='key == "cc" ' >
		AND (BOARD_TITLE LIKE '%${query}%' OR BOARD_CONTENT LIKE '%${query}%')
		</when>
		
		<when test='key == "dd" ' >
		AND MEMBER_NICKNAME LIKE '%${query}%'
		</when>
		
		<otherwise>
		AND TITLE_TAG_NAME LIKE '%${query}%'
		</otherwise>
</choose>
</if>

</select>

<!-- 전체 공지 목록 조회 진행중 -->
<select id="selectBoardAllNoticeList" parameterType="_int" resultMap="board_rm">
SELECT BOARD_NO, BOARD_CODE, TITLE_TAG_NO, TITLE_TAG_NAME, BOARD_TITLE, MEMBER_NO, MEMBER_NICKNAME, READ_COUNT, MEMBER_LEVEL_IMG, BOARD_NAME,
<![CDATA[
CASE  
      WHEN SYSDATE - B_CREATE_DATE < 1/24/60
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60 * 60 ) || '초 전'
      WHEN SYSDATE - B_CREATE_DATE < 1/24
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24 * 60) || '분 전'
      WHEN SYSDATE - B_CREATE_DATE < 1
      THEN FLOOR( (SYSDATE - B_CREATE_DATE) * 24) || '시간 전'
      ELSE TO_CHAR(B_CREATE_DATE, 'YYYY-MM-DD')
   END B_CREATE_DATE,
   ]]>
	(SELECT COUNT(*) FROM "COMMENT" C
	WHERE C.BOARD_NO =B.BOARD_NO AND COMMENT_DEL_FL = 'N') COMMENT_COUNT,
	(SELECT COUNT(*) FROM BOARD_LIKE L
	WHERE L.BOARD_NO = B.BOARD_NO) LIKE_COUNT
FROM BOARD B
JOIN MEMBER USING(MEMBER_NO)
LEFT JOIN TITLE_TAG USING(TITLE_TAG_NO)
LEFT JOIN MEMBER_LEVEL USING(MEMBER_LEVEL_NO)
JOIN BOARD_TYPE USING(BOARD_CODE)
WHERE BOARD_DEL_FL = 'N'
AND NOTICE_FL = 2
ORDER BY BOARD_NO DESC
</select>

</mapper>